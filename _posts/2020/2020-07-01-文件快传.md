---
title: 文件快传
categories: []
published: false
topmost: false
---

## 跨平台文件传输过程

主要分为三个过程：

1. 扫描并发现周围分享者，
2. 获取分享者的分享文件目录，
3. 文件传输

### 扫描并发现周围分享者
该过程是基于 BLE 的（BLE 扫描发现的速度快于 WiFi 扫描），主要是文件获取者扫描并发现周围所有文件分享者的基本信息（包括头像、性别、年龄、兴趣爱好等）。文件分享者打开 BLE 并广播，文件获取者打开 BLE 并扫描。由于在安卓系统上，只能发现周围广播的 BLE 而无法接收到 BLE 广播携带的数据，所以，文件分享者打开 BLE 广播的时候没有直接携带分享者信息。文件获取者获取文件分享者的信息是根据扫描到的文件分享者 BLE 的 UUID，向服务器请求文件分享者的基本信息。为了保证 UUID 的唯一性，UUID 是由用户在向服务器注册时由服务器自动分配的。用户每次在登录成功后，服务器即将该用户的 UUID 返回给用户，随后，用户即可利用该 UUID 进行 BLE 广播。
说明：由于 BLE 广播及扫描的范围有限，大概在 50m 左右，所以该过程只是在较小的范围内有效，但足以应对大多数的应用场景（比如餐厅，咖啡馆，教室等）

### 获取分享者的分享文件目录
文件获取者在获取到周围文件分享者的信息后，选择感兴趣的用户，即可向服务器获取该文件分享者所分享的文件目录（包含文件分享时间，文件名，文件简介），以列表形式展现在手机客户端。
**说明：**如果文件分享者希望删除某个已分享的文件，有两种情况，1、删除服务器上该文件的信息，而在本地不删除。2、直接删除本地文件。如果是第二种情况，则用户在删除本地文件时，服务器上的该文件分享信息也被一同删除。

### 文件传输
该过程又分为三种情况，1、安卓与安卓之间互传文件。2、iOS 和 iOS 之间互传文件。3、iOS 与安卓之间跨平台传输文件； 至于如何判断安卓与 iOS 系统，这是通过 BLE 的 UUID，也就是第一个过程的扫描并发现周围分享者。比如说：文件获取者扫描周围 BLE，根据扫描到的 BLE 的 UUID，可以判别对方是安卓还是 iOS 系统，继而决定是采用哪种文件传输过程。

#### 安卓与安卓之间互传文件
文件获取者，点击需要获取的文件，则服务器采用推送通知的方式通知文件分享者建立 wifi 热点，并建立 socket 服务器（wifi 热点名称的构成也是有一定规律的，可通过文件分享者的信息知道）。文件获取者自动接入该 wifi 热点，随后便通过 socket 通信传输文件。

#### iOS 与 iOS 之间互传文件
iOS 与 iOS 之间传输文件不需要推送通知，而是可以直接采用 multipeer connectivity 框架进行文件传输。

#### iOS 与安卓之间款平台传输文件
该过程又分为两种情况 1、iOS 客户端作为文件分享者，安卓端作为文件获取者，2、iOS 端作为文件获取者，安卓端作为文件分享者；由于 iOS 无法自动建立 WiFi 热点，在款平台传输时，所以无论 iOS 是作为文件获取者还是文件分享者，都是由安卓端建立 WiFi 热点和 socket 服务器。

1、iOS 端作为文件分享者，安卓端作为文件获取者
　用户获取者（安卓）点击获取文件后，同时建立 wifi 热点和 socket 服务器，并通过服务器，通知用户分享者（iOS）加入 WiFi 热点，并连接 socket 服务器。成功后利用 socket 通信进行文件传输。

2、iOS 端作为文件获取者，安卓端作为文件分享者
　文件获取者（iOS）点击“建立链接”，通过服务器，通知文件分享者（安卓）建立 WiFi 热点和 socket 服务器，文件获取者（iOS）手动接入热点，并链接 socket 服务器，继而进行 socket 通信，传输文件。

## 快传方案原理

发现阶段 -> 传输阶段

### 快传的整个流程的核心分为两部分:

- 发现阶段: 发送端和服务器端需要互相知道对方的标识.

- 传输阶段: 一旦双方知道对方的唯一标识以后, 可以通过建立数据链路来互相通信, 包括传输文件.

#### 发现阶段

UDP 广播: UDP 广播的先决条件是发送方和接收方处于同一个 Wifi 网络环境中. 如果发送方和接收方不在同一个 Wifi 环境中, 则无法发现.
蓝牙 广播: 地理位置限制, 要求发送方和接收方处于蓝牙协议允许的距离之内.
ZeroConf/Bonjour 协议: 基于 mdns 协议, 同一局域网的设备和服务发现.
服务器协助(背离初衷): 如果连接双方可以连接到服务器, 可以由服务器辅助发现.

#### 传输阶段

Wifi Direct
IP 网络传输
蓝牙传输

## 技术方案

快牙的技术方案主要采用以下两种:

UDP 在局域网内设备发现进行直连, 通过基于 TCP 的应用协议进行文件传输.
有局域网但是不能发现的情况下使用服务器中转的模式.
没有 Wifi 网络但是双方能连接到服务器上, 使用服务器中转的模式.

## 结论

现在看来, 通过 蓝牙 + 声波 进行设备发现, 通过 Wifi Direct 进行文件传输, 是一个近距离文件快速传输的主要方案. 其他的传输方案, 可以作为极端情况下或者非近距离情况下的补充.

iOS 和 Android 都支持 Wifi Direct
